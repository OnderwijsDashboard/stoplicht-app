<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Stoplicht - dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:20px;}
h2{display:flex;justify-content:space-between;align-items:center;}
h2 span{font-size:16px;color:#555;}
#clockDigital{font-size:18px;}
#clockAnalog{width:100px;height:100px;border:2px solid #333;border-radius:50%;position:relative;margin-left:20px;}
#clockAnalog .hand{width:50%;height:2px;background:#333;position:absolute;top:50%;left:50%;transform-origin:0% 50%;transform:rotate(0deg);}
#statusList{display:flex;flex-wrap:wrap;gap:10px;list-style:none;padding:0;}
.status-item{width:18%;min-width:120px;height:120px;border-radius:8px;background:#f7f7f7;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.dot{width:30px;height:30px;border-radius:50%;margin-bottom:8px;}
button{padding:8px 12px;margin:4px;border:none;border-radius:6px;cursor:pointer;}
#trafficLight{display:flex;gap:10px;margin:10px 0;}
.light{width:30px;height:30px;border-radius:50%;background:#bbb;}
#timerContainer{margin:10px 0;}
#groupList{margin:10px 0;}
</style>
</head>
<body>
<h2>
Stoplicht Dashboard 
<span>
<span id="clockDigital"></span>
<div id="clockAnalog">
  <div class="hand" id="hourHand"></div>
  <div class="hand" id="minuteHand"></div>
  <div class="hand" id="secondHand"></div>
</div>
</span>
</h2>

<div id="trafficLight">
  <button data-light="rood" style="background:#d9534f;color:white;">Rood: Stil</button>
  <button data-light="oranje" style="background:#f0ad4e;">Oranje: Fluisteren</button>
  <button data-light="groen" style="background:#5cb85c;color:white;">Groen: Normaal</button>
</div>

<div id="timerContainer">
  <label>Timer (minuten): <input type="number" id="timerMinutes" value="5" min="1"></label>
  <button id="startTimer">Start</button>
  <span id="timerDisplay"></span>
</div>

<div>
  <button id="startDag">Start van de dag</button>
</div>

<h3>Stoplicht leerlingen</h3>
<ul id="statusList"></ul>

<div>
  <button id="groupMaker">Maak groepjes</button>
  <ul id="groupList"></ul>
</div>

<div>
  <button id="namePicker">Kies een leerling</button>
  <span id="chosenName"></span>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyC8wWU5VUq6YLNzxBObFuVN8WYegKzZTPI",
  authDomain: "stoplichtblokje.firebaseapp.com",
  databaseURL: "https://stoplichtblokje-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "stoplichtblokje",
  storageBucket: "stoplichtblokje.firebasedatabase.app",
  messagingSenderId: "1019644227104",
  appId: "1:1019644227104:web:833b07ad778a8df5171645"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const statusList = document.getElementById('statusList');
const trafficButtons = document.querySelectorAll('#trafficLight button');
const timerDisplay = document.getElementById('timerDisplay');
const startTimerBtn = document.getElementById('startTimer');
const timerMinutesInput = document.getElementById('timerMinutes');
let timerInterval = null;

// Clock
function updateClock(){
  const now = new Date();
  document.getElementById('clockDigital').textContent = now.toLocaleTimeString();
  document.getElementById('hourHand').style.transform = `rotate(${30*now.getHours()+now.getMinutes()/2}deg)`;
  document.getElementById('minuteHand').style.transform = `rotate(${6*now.getMinutes()}deg)`;
  document.getElementById('secondHand').style.transform = `rotate(${6*now.getSeconds()}deg)`;
}
setInterval(updateClock,1000);
updateClock();

// Traffic light
trafficButtons.forEach(btn=>{
  btn.addEventListener('click',()=>{
    const light = btn.dataset.light;
    db.ref('class/trafficLight').set(light);
  });
});

// Timer
startTimerBtn.addEventListener('click',()=>{
  let minutes = parseInt(timerMinutesInput.value)||5;
  let endTime = Date.now()+minutes*60000;
  db.ref('class/timer').set({endTime,endTime, running:true});
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    let remaining = Math.max(0,endTime-Date.now());
    let mins = Math.floor(remaining/60000);
    let secs = Math.floor((remaining%60000)/1000);
    timerDisplay.textContent = `${mins}:${secs.toString().padStart(2,'0')}`;
    if(remaining<=0) clearInterval(timerInterval);
  },1000);
});

// Start van de dag
document.getElementById('startDag').addEventListener('click',()=>{
  db.ref('students').once('value').then(snap=>{
    const data = snap.val()||{};
    Object.keys(data).forEach(k=>{
      db.ref('students/'+k).update({status:'aanhetwerk',vraagTijd:null});
    });
  });
});

// Stoplicht leerlingen
db.ref('students').on('value',snap=>{
  const data = snap.val()||{};
  const items = Object.keys(data).map(k=>{
    return {id:k,name:data[k].name,status:data[k].status||'aanhetwerk',vraagTijd:data[k].vraagTijd||null};
  });
  items.sort((a,b)=>{
    if(a.status==='vraag' && b.status!=='vraag') return -1;
    if(a.status!=='vraag' && b.status==='vraag') return 1;
    if(a.status==='vraag' && b.status==='vraag') return (a.vraagTijd||0)-(b.vraagTijd||0);
    return 0;
  });
  statusList.innerHTML='';
  items.forEach(it=>{
    const li = document.createElement('li');
    li.className='status-item';
    const dot = document.createElement('div');
    dot.className='dot';
    if(it.status==='aanhetwerk') dot.style.background='#5cb85c';
    else if(it.status==='vraag') dot.style.background='#d9534f';
    li.appendChild(dot);
    const name = document.createElement('div');
    name.textContent = it.name;
    li.appendChild(name);
    statusList.appendChild(li);
  });
});

// Groepjesmaker
document.getElementById('groupMaker').addEventListener('click',()=>{
  db.ref('students').once('value').then(snap=>{
    const data = snap.val()||{};
    const names = Object.keys(data).map(k=>data[k].name);
    shuffleArray(names);
    const groupList = document.getElementById('groupList');
    groupList.innerHTML='';
    for(let i=0;i<names.length;i+=2){
      const li = document.createElement('li');
      li.textContent = names.slice(i,i+2).join(' & ');
      groupList.appendChild(li);
    }
  });
});

// Namenkiezer
document.getElementById('namePicker').addEventListener('click',()=>{
  db.ref('students').once('value').then(snap=>{
    const data = snap.val()||{};
    const names = Object.keys(data).map(k=>data[k].name);
    if(names.length===0) return;
    const chosen = names[Math.floor(Math.random()*names.length)];
    document.getElementById('chosenName').textContent = chosen;
  });
});

// Helper shuffle
function shuffleArray(array){
  for(let i=array.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [array[i],array[j]] = [array[j],array[i]];
  }
}
</script>
</body>
</html>
